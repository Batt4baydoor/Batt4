<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Garage Controller</title>
    <!-- Load Tailwind CSS for easy, clean styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-6 md:p-8">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Batt 4 Bay Door</h1>

        <!-- 1. LOGIN Container (Default View) -->
        <div id="login-container" class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 text-center">Access Required</h2>
            <input type="password" id="access-key-input" placeholder="Enter Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <!-- Hint added here -->
            <p id="key-hint" class="text-xs text-gray-500 text-right -mt-2">Hint: The old password for everything on quicklinks.</p>
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-md transition duration-150">
                Log In
            </button>
            <div id="login-status-message" class="text-center text-sm text-red-600 h-6"></div>
        </div>


        <!-- 2. CONTROL Container (Hidden until logged in) -->
        <div id="control-container" class="hidden">
            <!-- Button Grid: Changed to a single column (grid-cols-1) -->
            <div class="grid grid-cols-1 gap-4 mb-6">
                
                <button id="open-btn" data-action="open" class="btn open-btn bg-green-500 hover:bg-green-600 text-white py-4 rounded-lg font-bold shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02]">
                    OPEN
                </button>
                
                <button id="close-btn" data-action="close" class="btn close-btn bg-red-500 hover:bg-red-600 text-white py-4 rounded-lg font-bold shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02]">
                    CLOSE
                </button>
                
                <button id="stop-btn" data-action="stop" class="btn stop-btn bg-yellow-500 hover:bg-yellow-600 text-gray-800 py-4 rounded-lg font-bold shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02]">
                    STOP
                </button>

                <button id="close30-btn" data-action="close30" class="btn timed-btn bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-lg font-bold shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02]">
                    CLOSE FOR 30s
                </button>
            </div>
            
            <!-- Logout Button -->
            <button id="logout-btn" class="w-full text-sm mt-4 text-gray-500 hover:text-red-500 transition duration-150">
                Log Out
            </button>
        </div>

        <!-- Status Message Area -->
        <div id="status-message" class="text-center p-3 rounded-lg font-medium transition-all duration-300 h-10">
            <!-- Messages will appear here -->
        </div>
    </div>

    <script>
        // --- SECURITY WARNING: This is client-side authentication and is NOT SECURE. 
        // The key is stored in the source code and only prevents casual access.
        const ACCESS_KEY = "dfrs12"; // <-- CHANGE THIS TO YOUR SECRET KEY!
        const STORAGE_KEY = "garageAccessGranted"; 
        // --- END SECURITY WARNING ---

        const BASE_WEBHOOK_URL = 'https://io.adafruit.com/api/v2/webhooks/feed/mHSaPrVAdpi9qgT4nLCoMCovNE95'; 

        const WEBHOOK_URLS = {
            'open': BASE_WEBHOOK_URL,
            'close': BASE_WEBHOOK_URL,
            'stop': BASE_WEBHOOK_URL,
            'close30': BASE_WEBHOOK_URL,
        };

        const loginContainer = document.getElementById('login-container');
        const controlContainer = document.getElementById('control-container');
        const statusMessage = document.getElementById('status-message');
        const loginStatusMessage = document.getElementById('login-status-message');
        const accessKeyInput = document.getElementById('access-key-input');
        
        let messageTimeout = null;

        // --- AUTHENTICATION LOGIC ---

        function showControls() {
            loginContainer.classList.add('hidden');
            controlContainer.classList.remove('hidden');
            loginStatusMessage.textContent = "";
            accessKeyInput.value = ""; // Clear input after successful login
        }

        function showLogin() {
            controlContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            statusMessage.textContent = ""; // Clear main status message
        }

        function attemptLogin() {
            const enteredKey = accessKeyInput.value.trim();
            if (enteredKey === ACCESS_KEY) {
                // Successful login
                localStorage.setItem(STORAGE_KEY, 'true');
                showControls();
            } else {
                // Failed login
                loginStatusMessage.textContent = "Invalid Key";
                accessKeyInput.value = "";
                accessKeyInput.focus();
            }
        }

        function logout() {
            localStorage.removeItem(STORAGE_KEY);
            showLogin();
            setStatusMessage("Logged out successfully.", 'default');
        }

        function checkLogin() {
            if (localStorage.getItem(STORAGE_KEY) === 'true') {
                showControls();
            } else {
                showLogin();
            }
        }

        // --- STATUS MESSAGE (UNCHANGED) ---

        function setStatusMessage(message, type) {
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }

            let classes = "p-3 rounded-lg font-medium";
            
            if (type === 'success') {
                classes += " bg-green-100 text-green-700 shadow-inner";
            } else if (type === 'error') {
                classes += " bg-red-100 text-red-700 shadow-inner";
            } else {
                classes += " bg-gray-200 text-gray-600 shadow-inner";
            }

            statusMessage.className = classes;
            statusMessage.textContent = message;

            messageTimeout = setTimeout(() => {
                statusMessage.textContent = '';
                statusMessage.className = "text-center p-3 rounded-lg font-medium transition-all duration-300 h-10";
            }, 5000);
        }

        // --- COMMAND SENDING (UNCHANGED) ---

        async function sendCommand(action) {
            const url = WEBHOOK_URLS[action];
            
            if (!url || url.includes('YOUR_')) {
                setStatusMessage(`Error: Webhook URL for ${action.toUpperCase()} is incomplete.`, 'error');
                return;
            }

            const payload = { value: action };
            setStatusMessage(`Sending '${action.toUpperCase()}' command...`, 'pending');

            try {
                const response = await fetch(url, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload) 
                }); 

                if (response.ok) {
                    const message = action === 'close30' 
                        ? 'SUCCESS! Holding "Close" for 30 seconds.' 
                        : `SUCCESS! Door action: ${action.toUpperCase()} command sent.`;
                    
                    setStatusMessage(message, 'success');
                } else {
                    let errorText = await response.text();
                    errorText = errorText.substring(0, 100) || 'No details provided.'; 
                    setStatusMessage(`API ERROR: Failed to send command. Status ${response.status}. Error: ${errorText}`, 'error');
                }
            } catch (error) {
                setStatusMessage(`CONNECTION ERROR: Could not reach the webhook server. Error: ${error.message}`, 'error');
            }
        }

        // --- EVENT LISTENERS ---
        
        // Initial check when page loads
        document.addEventListener('DOMContentLoaded', checkLogin);

        // Login Button Listener
        document.getElementById('login-btn').addEventListener('click', attemptLogin);
        
        // Allow Enter key to submit login
        accessKeyInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                attemptLogin();
            }
        });

        // Logout Button Listener
        document.getElementById('logout-btn').addEventListener('click', logout);

        // Command Button Listeners
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const action = event.currentTarget.getAttribute('data-action');
                sendCommand(action);
            });
        });

    </script>
</body>
</html>
