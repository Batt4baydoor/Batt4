<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Garage Controller</title>
    <!-- Load Tailwind CSS for easy, clean styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-6 md:p-8">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Batt 4 Bay Door</h1>

        <!-- Button Grid: Changed to a single column (grid-cols-1) -->
        <div class="grid grid-cols-1 gap-4 mb-6">
            
            <button id="open-btn" data-action="open" class="btn open-btn bg-green-500 hover:bg-green-600 text-white py-4 rounded-lg font-bold shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02]">
                OPEN
            </button>
            
            <button id="close-btn" data-action="close" class="btn close-btn bg-red-500 hover:bg-red-600 text-white py-4 rounded-lg font-bold shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02]">
                CLOSE
            </button>
            
            <button id="stop-btn" data-action="stop" class="btn stop-btn bg-yellow-500 hover:bg-yellow-600 text-gray-800 py-4 rounded-lg font-bold shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02]">
                STOP
            </button>

            <button id="close30-btn" data-action="close30" class="btn timed-btn bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-lg font-bold shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02]">
                CLOSE FOR 30s
            </button>
        </div>
        
        <!-- NEW: Status Message Area -->
        <div id="status-message" class="text-center p-3 rounded-lg font-medium transition-all duration-300 h-10">
            <!-- Messages will appear here -->
        </div>
    </div>

    <!-- The Confirmation Modal element is now removed -->

    <script>
        // --- IMPORTANT: BASE_WEBHOOK_URL is now configured with the URL provided by the user.
        const BASE_WEBHOOK_URL = 'https://io.adafruit.com/api/v2/webhooks/feed/mHSaPrVAdpi9qgT4nLCoMCovNE95'; 

        // The full URLs are constructed without query parameters, as the command is now sent in the POST body.
        const WEBHOOK_URLS = {
            'open': BASE_WEBHOOK_URL,
            'close': BASE_WEBHOOK_URL,
            'stop': BASE_WEBHOOK_URL,
            'close30': BASE_WEBHOOK_URL,
        };

        const statusMessage = document.getElementById('status-message');
        let messageTimeout = null;

        /**
         * @brief Displays a status message at the bottom of the page and clears it after 5 seconds.
         * @param {string} message - The message body.
         * @param {string} type - 'success' or 'error' for coloring.
         */
        function setStatusMessage(message, type) {
            // Clear any existing timeout
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }

            let classes = "p-3 rounded-lg font-medium";
            
            if (type === 'success') {
                classes += " bg-green-100 text-green-700 shadow-inner";
            } else if (type === 'error') {
                classes += " bg-red-100 text-red-700 shadow-inner";
            } else {
                classes += " bg-gray-200 text-gray-600 shadow-inner";
            }

            statusMessage.className = classes;
            statusMessage.textContent = message;

            // Automatically clear the message after 5 seconds
            messageTimeout = setTimeout(() => {
                statusMessage.textContent = '';
                statusMessage.className = "text-center p-3 rounded-lg font-medium transition-all duration-300 h-10"; // Reset to initial class
            }, 5000);
        }

        /**
         * @brief Sends the HTTP request to the Adafruit IO Webhook.
         * @param {string} action - The command to execute (e.g., 'open').
         */
        async function sendCommand(action) {
            const url = WEBHOOK_URLS[action];
            
            if (!url || url.includes('YOUR_')) {
                setStatusMessage(`Error: Webhook URL for ${action.toUpperCase()} is incomplete.`, 'error');
                return;
            }

            // Prepare the JSON payload for the POST request
            const payload = {
                value: action
            };

            // Display a pending message
            setStatusMessage(`Sending '${action.toUpperCase()}' command...`, 'pending');

            try {
                // Use POST and include the body with the command value
                const response = await fetch(url, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload) 
                }); 

                if (response.ok) {
                    const message = action === 'close30' 
                        ? 'SUCCESS! Closing sequence initiated for 30 seconds.' 
                        : `SUCCESS! Door action: ${action.toUpperCase()} command sent.`;
                    
                    setStatusMessage(message, 'success');
                } else {
                    // Check if the body contains meaningful error text
                    let errorText = await response.text();
                    errorText = errorText.substring(0, 100) || 'No details provided.'; 
                    setStatusMessage(`API ERROR: Failed to send command. Status ${response.status}. Error: ${errorText}`, 'error');
                }
            } catch (error) {
                setStatusMessage(`CONNECTION ERROR: Could not reach the webhook server. Error: ${error.message}`, 'error');
            }
        }

        // Attach event listeners to all buttons with the class 'btn'
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const action = event.currentTarget.getAttribute('data-action');
                sendCommand(action);
            });
        });

    </script>
</body>
</html>
